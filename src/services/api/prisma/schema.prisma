generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  /// PK: e.g. STU0001, AUTH0001
  user_id       String   @id
  name          String
  email         String   @unique
  phone         String?
  avatar_url    String?
  /// 'Student' | 'Author' | 'Admin'
  role          String
  /// 'Regular' | 'VIP', default 'Regular'
  membership    String   @default("Regular")
  created_at    DateTime
  hash_password String

  // Relations
  authoredTests Test[]  @relation("UserTests")
  trials        Trial[] @relation("StudentTrials")
}

model Test {
  /// PK: varchar(10), e.g. '00001'
  /// Note: autoincrement formatting (00001) is handled in app logic, not Prisma.
  test_id    String    @id
  author_id  String
  title      String
  /// nullable for 'practice'
  start_time DateTime?
  /// 'exam' | 'practice'
  type       String
  /// 'Premium' | 'Regular', default 'Regular'
  status     String    @default("Regular")
  /// nullable for 'practice'
  due_time   DateTime?
  url        String
  /// duration in seconds, can be null if you want
  duration   Int?

  // Relations
  author User    @relation("UserTests", fields: [author_id], references: [user_id])
  trials Trial[]
  questions Question[]
  
  @@index([type, start_time])
  @@index([author_id])
}

model Trial {
  /// PK: e.g. "STU0001_00001_001"
  trial_id        String   @id
  student_id      String
  test_id         String
  start_time      DateTime
  end_time        DateTime
  raw_score       Json?
  processed_score Json?
  tactic          Json?

  // Relations
  student   User       @relation("StudentTrials", fields: [student_id], references: [user_id], onDelete: Cascade)
  test      Test       @relation(fields: [test_id], references: [test_id], onDelete: Cascade)
  responses Response[]

  @@index([student_id, start_time])
  @@index([test_id])
}

model Response {
  /// composite PK (trial_id, question_id)
  trial_id      String
  question_id   String
  /// 'A' | 'B' | 'C' | 'D', nullable
  chosen_option String?
  /// time in seconds (>= 0)
  response_time Decimal

  // Relations
  trial Trial @relation(fields: [trial_id], references: [trial_id], onDelete: Cascade)
  // Relations to Question (questions table)
  question Question @relation(fields: [question_id], references: [question_id], onDelete: Cascade)

  @@id([trial_id, question_id])
}

model Question {
  /// PK: e.g. "00001_Q1" or any unique id
  question_id    String  @id
  /// relative weight/score for this question
  relative_score Int
  test_id        String
  /// 'A' | 'B' | 'C' | 'D' etc
  correct_option String?

  // Relations
  test Test @relation(fields: [test_id], references: [test_id], onDelete: Cascade)
  responses Response[]

  @@index([test_id])
}

model News {
  news_id     String   @id @default(uuid())
  title       String
  excerpt     String?  // Đoạn trích ngắn mô tả bài viết
  content     String?  // Nội dung chi tiết
  author      String   // Tên tác giả
  image       String?  // URL ảnh thumbnail
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

model Notification {
  notification_id        String   @id @default(uuid())
  title     String
  message   String?
  type      String   // 'exam', 'news', 'leaderboard', 'system'
  link      String?  // Link for directing (ex: /exams)
  created_at DateTime @default(now()) @map("created_at")
  
  // userId = null mearns Broadcast (notify to all users)
  user_id    String?  @map("user_id") 

  @@map("Notification")
  @@index([user_id, created_at])
}